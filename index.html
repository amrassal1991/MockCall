<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced AI Call Simulator</title>
    <!-- Chosen Palette: Dark Theme - A modern, dark-themed palette using a near-black background (#0a0a0a), slightly lighter containers (#1a1a1a), and a vibrant blue accent (#1a6cd0) for interactive elements. Text is white for high contrast. Success and error states are indicated by green (#10b981) and red (#ef4444) respectively, providing clear visual feedback. -->
    <!-- Application Structure Plan: The application is structured as a single-page dashboard centered around a three-bot AI simulation model. The UI is divided into three main areas: 1) A top-level 'Settings' bar for configuring the simulation (Tone, Language, Timeout, Customer Type, Topic). 2) The core 'Interaction' view with the chat transcript and controls. 3) A right-hand 'Live Analysis' sidebar where the Quality Coach Bot provides real-time feedback. A post-call modal provides the final report from the Organizer Bot, including an export function and a conditional survey. This structure was chosen to provide a clear, logical flow for the user: configure, interact, analyze, and review. It separates the distinct functions of the simulation (interaction vs. analysis) for better usability, while the three-bot JS architecture mirrors this functional separation in the code. -->
    <!-- Visualization & Content Choices: The primary content is the chat log, a familiar and intuitive text-based presentation. Key metrics from the Quality Coach are presented as numeric scores with emoji indicators (üí° for a new idea, ‚ÑπÔ∏è for info) and concise text feedback, making them quickly scannable. The key new visualization is a bar chart in the final report (Goal: Show Change), generated with Chart.js, which tracks the quality score turn-by-turn, allowing for easy identification of trends and pivotal moments in the conversation. The final report itself (Goal: Organize/Inform) is a structured text block with clear headings, making complex analysis digestible. User feedback is collected via standard form elements (range slider for rating, textarea for verbatim) for ease of use. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-main: #f4f4f5; /* Light Gray */
            --bg-container: #ffffff;
            --bg-message-ai: #e4e4e7; /* Lighter Gray */
            --bg-message-user: #3b82f6; /* Blue */
            --text-main: #18181b; /* Near Black */
            --text-secondary: #52525b;
            --text-user-message: #ffffff;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --error-color: #ef4444;
            --quality-bg: #e4e4e7;
            --quality-border: #d4d4d8;
            --quality-score-good: #10b981;
            --quality-score-bad: #ef4444;
            --quality-score-neutral: #f59e0b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
        }
        
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 3px;}
        .chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        #loader-overlay {
            z-index: 50;
        }
    </style>
</head>

<body class="flex h-screen w-screen text-sm">

    <!-- Main container -->
    <div class="flex flex-col h-full w-full bg-gray-100">

        <!-- Header/Settings -->
        <header class="flex items-center justify-between p-3 bg-white border-b border-gray-200 shadow-sm">
            <h1 class="text-xl font-bold text-gray-800">AI Call Simulator</h1>
            <div class="flex items-center space-x-4">
                 <!-- Settings Section -->
                 <div class="flex items-center space-x-2">
                    <label for="tone-select" class="font-medium text-gray-600">Tone:</label>
                    <select id="tone-select" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="Professional">Professional</option>
                        <option value="Empathetic">Empathetic</option>
                        <option value="Direct">Direct</option>
                        <option value="Friendly">Friendly</option>
                    </select>
                </div>
                 <div class="flex items-center space-x-2">
                    <label for="timeout-input" class="font-medium text-gray-600">Auto-Send (s):</label>
                    <input type="number" id="timeout-input" value="3" min="1" max="10" class="w-16 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Persona Section -->
                 <div class="flex items-center space-x-2">
                    <label for="customer-type-select" class="font-medium text-gray-600">Customer Type:</label>
                    <select id="customer-type-select" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="Any">Any</option>
                        <option value="Frustrated">Frustrated</option>
                        <option value="Inquiry">Inquiry</option>
                        <option value="Rude">Rude</option>
                        <option value="Fraudster (Simulated)">Fraudster (Simulated)</option>
                    </select>
                </div>
                 <div class="flex items-center space-x-2">
                    <label for="topic-select" class="font-medium text-gray-600">Topic:</label>
                    <select id="topic-select" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="Any">Any</option>
                        <option value="Internet Service">Internet Service</option>
                        <option value="Internet Speed">Internet Speed</option>
                        <option value="Billing">Billing</option>
                        <option value="Account Security">Account Security</option>
                        <option value="Technical Support">Technical Support</option>
                        <option value="Service Complaint">Service Complaint</option>
                    </select>
                </div>
                 <div class="flex items-center space-x-2">
                    <label for="lang-select" class="font-medium text-gray-600">Language:</label>
                    <select id="lang-select" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="en-US">English</option>
                        <option value="es-ES">Spanish</option>
                    </select>
                </div>
                <button id="new-call-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                    New Call
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex flex-1 overflow-hidden p-4 gap-4">

            <!-- Left Panel: Chat -->
            <div class="flex flex-col w-2/3 bg-white rounded-lg shadow-md border border-gray-200">
                <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto chat-container">
                    <!-- Messages will be injected here -->
                </div>
                <div class="p-4 border-t border-gray-200">
                    <div id="status" class="text-center text-gray-500 mb-2 h-5"></div>
                    <div class="flex items-center space-x-2">
                        <textarea id="message-input" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Speak or type your message..." rows="2"></textarea>
                        <button id="mic-btn" class="p-3 bg-gray-200 rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 11.5a5.5 5.5 0 0011 0h-1.5a4 4 0 01-8 0H5.5z"/><path d="M3 10a.5.5 0 00.5.5v1a4.5 4.5 0 008.552 2.036.5.5 0 10-.9-.408A3.5 3.5 0 018.5 14.5v-1a.5.5 0 00-1 0v1a.5.5 0 001 0v-1a.5.5 0 00-1 0v1a.5.5 0 001 0V12a.5.5 0 00-1 0v.5a3.5 3.5 0 01-7 0v-.5a.5.5 0 00-1 0v.5A4.5 4.5 0 008 15.91V16H5a1 1 0 000 2h10a1 1 0 000-2h-3v-.09A4.5 4.5 0 0016.5 11.5v-.5a.5.5 0 00-1 0v.5a3.5 3.5 0 01-7 0v-.5a.5.5 0 00-.5-.5H3z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Live Analysis -->
            <div class="flex flex-col w-1/3 bg-white rounded-lg shadow-md border border-gray-200">
                <h2 class="p-4 text-lg font-bold border-b border-gray-200">Live Quality Analysis</h2>
                <div id="quality-feedback-panel" class="flex-1 p-4 space-y-3 overflow-y-auto">
                   <div class="text-gray-500 text-center pt-8">Waiting for first interaction...</div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Report/Survey Modal -->
    <div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-2xl font-bold">Call Report & Survey</h2>
                <button id="close-report-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Report Content -->
                <div id="report-content">
                    <h3 class="text-xl font-semibold mb-4">Interaction Analysis</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-bold text-gray-700 mb-2">Call Summary</h4>
                            <p id="report-summary" class="text-gray-600 bg-gray-50 p-3 rounded-md"></p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-700 mb-2">Key Metrics</h4>
                            <div id="report-metrics" class="space-y-2"></div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-bold text-gray-700 mb-2">Quality Score Trend</h4>
                        <div class="chart-container relative h-64 w-full max-w-2xl mx-auto">
                            <canvas id="quality-chart"></canvas>
                        </div>
                    </div>
                    <div class="mt-6">
                       <h4 class="font-bold text-gray-700 mb-2">Organizer Bot Assessment</h4>
                       <div id="organizer-assessment" class="text-gray-600 bg-gray-50 p-4 rounded-md space-y-3"></div>
                    </div>
                </div>
                <!-- Survey Section -->
                <div id="survey-section" class="hidden mt-8 border-t pt-6">
                    <h3 class="text-xl font-semibold mb-2">How did we do?</h3>
                    <p class="text-gray-600 mb-4">Your feedback helps us improve.</p>
                    <div class="mb-4">
                        <label for="satisfaction-rating" class="block font-medium text-gray-700 mb-2">Overall Satisfaction (1-10): <span id="rating-value" class="font-bold text-blue-600">5</span></label>
                        <input type="range" id="satisfaction-rating" min="1" max="10" value="5" class="w-full">
                    </div>
                    <div class="mb-4">
                        <label for="verbatim-feedback" class="block font-medium text-gray-700 mb-2">Additional Comments:</label>
                        <textarea id="verbatim-feedback" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tell us more about your experience..."></textarea>
                    </div>
                    <button id="submit-survey-btn" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">Submit Feedback</button>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button id="export-report-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">Export Report (.txt)</button>
            </div>
        </div>
    </div>
    
    <!-- Loader Overlay -->
    <div id="loader-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-gray-700 font-semibold" id="loader-text">AI is thinking...</p>
        </div>
    </div>

    <script type="module">
        // --- DATA ---
        const complaints = {
            internet: [{id: "int_001",type: "Service Interruption",scenario: "Internet service has been intermittent for the past 24 hours, affecting business operations",initialComplaint: { "en-US": "My business internet keeps dropping every hour! We've lost thousands in sales because our payment system is down. This is completely unacceptable for a business account!", "es-ES": "¬°El internet de mi negocio se cae cada hora! Hemos perdido miles en ventas porque nuestro sistema de pago no funciona. ¬°Esto es completamente inaceptable para una cuenta de negocios!"}, customerName: "Maria Garcia",difficulty: "high", customerType: "Frustrated", topic: "Internet Service"},{id: "int_002",type: "Speed Issues",scenario: "Business customer reporting significantly slower speeds than promised",initialComplaint: { "en-US": "We're only getting 50Mbps when we're paying for 300Mbps. Our video conferences with clients keep freezing!", "es-ES": "Solo estamos recibiendo 50Mbps cuando pagamos por 300Mbps. ¬°Nuestras videoconferencias con clientes se congelan!"}, customerName: "John Smith",difficulty: "medium", customerType: "Inquiry", topic: "Internet Speed"}],
            billing: [{id: "bill_001",type: "Incorrect Charge",scenario: "Customer sees an unexpected charge on their monthly bill",initialComplaint: { "en-US": "Why was I charged for 'premium support'? I never asked for that and I want it removed immediately.", "es-ES": "¬øPor qu√© me cobraron por 'soporte premium'? Nunca lo ped√≠ y quiero que lo quiten de inmediato."}, customerName: "David Chen",difficulty: "low", customerType: "Inquiry", topic: "Billing"}],
            fraud: [
                {
                    id: "fraud_001",
                    type: "Unauthorized Activity",
                    scenario: "Customer reports suspicious activity on their account",
                    initialComplaint: { "en-US": "Someone used my account to order services I didn't authorize! This is fraud!", "es-ES": "¬°Alguien us√≥ mi cuenta para pedir servicios que no autoric√©! ¬°Esto es un fraude!"},
                    customerName: "Sarah Connor",
                    difficulty: "critical",
                    customerType: "Fraudster (Simulated)",
                    topic: "Account Security"
                }
            ],
            technical: [
                {
                    id: "tech_001",
                    type: "Technical Support",
                    scenario: "Customer needs help setting up new equipment",
                    initialComplaint: { "en-US": "I just got my new modem, but I can't get it to connect to the internet. Can you walk me through it?", "es-ES": "Acabo de recibir mi nuevo m√≥dem, pero no puedo conectarlo a internet. ¬øPuedes guiarme?"},
                    customerName: "Robert Johnson",
                    difficulty: "low",
                    customerType: "Inquiry",
                    topic: "Technical Support"
                }
            ],
            rude: [
                {
                    id: "rude_001",
                    type: "Service Complaint",
                    scenario: "Customer is extremely angry about a recent service interaction",
                    initialComplaint: { "en-US": "This is the third time I've called about this! Your service is absolutely terrible, and I want to speak to a supervisor NOW!", "es-ES": "¬°Esta es la tercera vez que llamo por esto! ¬°Su servicio es absolutamente terrible y quiero hablar con un supervisor AHORA MISMO!"},
                    customerName: "Karen Miller",
                    difficulty: "critical",
                    customerType: "Rude",
                    topic: "Service Complaint"
                }
            ]
        };

        // --- CORE APPLICATION LOGIC ---
        class AppController {
            constructor() {
                // DOM Binding
                this.micBtn = document.getElementById('mic-btn');
                this.messageInput = document.getElementById('message-input');
                this.chatMessages = document.getElementById('chat-messages');
                this.statusEl = document.getElementById('status');
                this.qualityPanel = document.getElementById('quality-feedback-panel');
                this.loader = document.getElementById('loader-overlay');
                this.loaderText = document.getElementById('loader-text');
                this.toneSelect = document.getElementById('tone-select');
                this.langSelect = document.getElementById('lang-select');
                this.timeoutInput = document.getElementById('timeout-input');
                this.customerTypeSelect = document.getElementById('customer-type-select'); // New
                this.topicSelect = document.getElementById('topic-select'); // New
                this.newCallBtn = document.getElementById('new-call-btn');
                this.reportModal = document.getElementById('report-modal');
                this.closeReportBtn = document.getElementById('close-report-btn');
                this.exportReportBtn = document.getElementById('export-report-btn');
                this.surveySection = document.getElementById('survey-section');
                this.satisfactionRating = document.getElementById('satisfaction-rating');
                this.ratingValue = document.getElementById('rating-value');
                this.submitSurveyBtn = document.getElementById('submit-survey-btn');


                // State
                this.state = {
                    isRecognizing: false,
                    currentTranscript: '',
                    silenceTimer: null,
                    turnCount: 0,
                    callInProgress: false,
                    currentScenario: {},
                    chatHistory: [],
                    qualityScores: [],
                    fullConversationForReport: [],
                };
                
                // Services / Bots
                this.speechService = new SpeechService(
                    () => this.state.isRecognizing,
                    (isRecognizing) => this.setRecognitionState(isRecognizing),
                    (transcript) => this.handleRecognitionResult(transcript),
                    (error) => this.handleRecognitionError(error)
                );
                
                this.geminiAPI = new GeminiAPIService();

                this.bindEventListeners();
                this.startNewCall();
            }

            bindEventListeners() {
                this.micBtn.addEventListener('click', () => this.speechService.toggleRecognition(this.state.currentLanguage));
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage(this.messageInput.value);
                    }
                });
                this.newCallBtn.addEventListener('click', () => this.startNewCall());
                this.closeReportBtn.addEventListener('click', () => this.reportModal.classList.add('hidden'));
                this.exportReportBtn.addEventListener('click', () => this.exportReport());
                this.satisfactionRating.addEventListener('input', (e) => {
                    this.ratingValue.textContent = e.target.value;
                });
            }

            startNewCall() {
                // Reset state
                this.state.turnCount = 0;
                this.state.callInProgress = true;
                this.state.chatHistory = [];
                this.state.qualityScores = [];
                this.state.fullConversationForReport = [];
                this.messageInput.value = '';
                this.chatMessages.innerHTML = '';
                this.qualityPanel.innerHTML = '<div class="text-gray-500 text-center pt-8">Waiting for first interaction...</div>';
                this.reportModal.classList.add('hidden');
                this.surveySection.classList.add('hidden');
                this.messageInput.disabled = false;
                this.micBtn.disabled = false;
                
                // Get settings
                const lang = this.langSelect.value;
                this.state.currentLanguage = lang;
                const selectedCustomerType = this.customerTypeSelect.value;
                const selectedTopic = this.topicSelect.value;
                
                // Select a random scenario based on filters
                let availableScenarios = Object.values(complaints).flat();

                if (selectedCustomerType !== 'Any') {
                    availableScenarios = availableScenarios.filter(s => s.customerType === selectedCustomerType);
                }
                if (selectedTopic !== 'Any') {
                    availableScenarios = availableScenarios.filter(s => s.topic === selectedTopic);
                }

                if (availableScenarios.length === 0) {
                    this.addMessage(lang === 'es-ES' ? 'No se encontraron escenarios con los filtros seleccionados. Reiniciando con cualquier escenario.' : 'No scenarios found with selected filters. Resetting with any scenario.', 'system');
                    availableScenarios = Object.values(complaints).flat(); // Fallback to all scenarios
                }

                this.state.currentScenario = availableScenarios[Math.floor(Math.random() * availableScenarios.length)];
                
                const scenarioText = this.state.currentScenario.initialComplaint[lang];
                this.state.customerPersona = this.getPersonaPrompt(this.state.currentScenario.customerName, scenarioText);

                // Initial system message
                const systemMessage = lang === 'es-ES' ?
                    `Nueva llamada entrante de ${this.state.currentScenario.customerName}. Motivo: ${this.state.currentScenario.scenario}. Comience la llamada.` :
                    `New call incoming from ${this.state.currentScenario.customerName}. Reason: ${this.state.currentScenario.scenario}. Please begin the call.`;

                this.addMessage(systemMessage, 'system');
            }

            getPersonaPrompt(name, complaint) {
                 const lang = this.langSelect.value;
                 if(lang === 'es-ES') {
                    return `Eres un cliente de habla hispana llamado ${name}. Tu problema es: "${complaint}". Est√°s frustrado pero intentas ser educado. Mant√©n tus respuestas relativamente cortas. NO resuelvas el problema demasiado r√°pido. Si el agente te da una buena soluci√≥n, ac√©ptala.`;
                 }
                 return `You are a customer named ${name}. Your issue is: "${complaint}". You are frustrated but trying to be polite. Keep your responses relatively short. DO NOT solve the issue too quickly. If the agent gives a good resolution, accept it.`;
            }

            setRecognitionState(isRecognizing) {
                this.state.isRecognizing = isRecognizing;
                this.micBtn.classList.toggle('bg-red-500', isRecognizing);
                this.micBtn.classList.toggle('text-white', isRecognizing);
                this.statusEl.textContent = isRecognizing ? (this.state.currentLanguage === 'es-ES' ? 'Escuchando...' : 'Listening...') : '';
            }

            handleRecognitionResult(transcript) {
                this.messageInput.value = transcript;
                this.state.currentTranscript = transcript;
                clearTimeout(this.state.silenceTimer);

                // Voice commands
                const command = transcript.toLowerCase().trim();
                if (command.endsWith('send') || command.endsWith('enviar')) {
                    const messageToSend = transcript.replace(/send|enviar/gi, '').trim();
                    this.sendMessage(messageToSend);
                    return;
                }
                if (command.endsWith('delete') || command.endsWith('borrar')) {
                    this.messageInput.value = '';
                    this.state.currentTranscript = '';
                    this.statusEl.textContent = this.state.currentLanguage === 'es-ES' ? 'Borrado. Escuchando de nuevo...' : 'Deleted. Listening again...';
                    // Don't stop recognition, allow user to try again
                    return;
                }
                
                // Auto-send timer
                const timeoutSeconds = parseInt(this.timeoutInput.value, 10) * 1000;
                this.state.silenceTimer = setTimeout(() => {
                    this.sendMessage(this.state.currentTranscript);
                }, timeoutSeconds);
            }

            handleRecognitionError(error) {
                this.statusEl.textContent = `Error: ${error}`;
            }

            async sendMessage(text) {
                if (!text || !this.state.callInProgress) return;

                this.speechService.stopRecognition();
                clearTimeout(this.state.silenceTimer);
                this.messageInput.value = '';
                this.state.currentTranscript = '';

                this.addMessage(text, 'user');
                this.state.chatHistory.push({ role: 'user', parts: [{ text }] });
                this.state.fullConversationForReport.push({ speaker: 'Agent', text });


                this.state.turnCount++;
                if (this.state.turnCount > 0) {
                   if (this.qualityPanel.innerHTML.includes("Waiting for first interaction")) {
                       this.qualityPanel.innerHTML = '';
                   }
                }
                
                this.showLoader(true, 'Customer is responding...');

                // Get Customer Response
                const customerResponse = await this.geminiAPI.generateContent(this.buildPrompt(this.state.customerPersona));
                this.addMessage(customerResponse, 'ai');
                this.state.chatHistory.push({ role: 'model', parts: [{ text: customerResponse }] });
                this.state.fullConversationForReport.push({ speaker: 'Customer', text: customerResponse });

                // Get Quality Coach Feedback
                this.showLoader(true, 'Quality Coach is analyzing...');
                const qualityFeedback = await this.getQualityFeedback(text, customerResponse);
                this.displayQualityFeedback(qualityFeedback);
                this.state.qualityScores.push(qualityFeedback.score);

                this.showLoader(false);

                // Check for call end condition
                if (this.state.turnCount >= 6 + Math.floor(Math.random() * 5)) { // 6-10 turns
                    this.endCall();
                }
            }

            async getQualityFeedback(agentMessage, customerMessage) {
                const lang = this.langSelect.value;
                const prompt = lang === 'es-ES' ? 
                    `Como especialista en control de calidad, eval√∫a la respuesta del agente. Cliente: "${customerMessage}". Agente: "${agentMessage}". Proporciona una puntuaci√≥n de 0 a 100 y un comentario breve y constructivo sobre la empat√≠a, la claridad y la resoluci√≥n de problemas. Devuelve solo un objeto JSON con las claves "score" (n√∫mero) y "comment" (cadena).` :
                    `As a Quality Assurance Specialist, evaluate the agent's response. Customer: "${customerMessage}". Agent: "${agentMessage}". Provide a score from 0-100 and a brief, constructive comment on empathy, clarity, and problem-solving. Return only a JSON object with keys "score" (number) and "comment" (string).`;
                
                try {
                    const responseText = await this.geminiAPI.generateContent(prompt);
                    const cleanedText = responseText.replace(/```json|```/g, '').trim();
                    return JSON.parse(cleanedText);
                } catch (e) {
                    console.error("Failed to parse quality feedback:", e);
                    return { score: 0, comment: "Error getting quality feedback." };
                }
            }

            addMessage(text, sender, name) {
                const div = document.createElement('div');
                div.className = `w-full flex ${sender === 'user' || sender === 'system' ? 'justify-end' : 'justify-start'}`;
                
                const messageBubble = document.createElement('div');
                let bubbleClass;
                let senderName = '';

                switch (sender) {
                    case 'user':
                        bubbleClass = 'bg-blue-500 text-white';
                        senderName = 'Agent';
                        break;
                    case 'ai':
                        bubbleClass = 'bg-gray-200 text-gray-800';
                        senderName = this.state.currentScenario.customerName || 'Customer';
                        break;
                    case 'system':
                        bubbleClass = 'bg-yellow-100 text-yellow-800 border border-yellow-300';
                        senderName = 'System';
                        break;
                }

                messageBubble.className = `max-w-md lg:max-w-lg p-3 rounded-lg shadow ${bubbleClass}`;
                messageBubble.innerHTML = `<div class="font-bold text-sm mb-1">${senderName}</div><div>${text}</div>`;
                
                div.appendChild(messageBubble);
                this.chatMessages.appendChild(div);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            displayQualityFeedback({ score, comment }) {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';

                let scoreColorClass;
                if (score >= 85) scoreColorClass = 'text-green-600 bg-green-100';
                else if (score >= 60) scoreColorClass = 'text-yellow-600 bg-yellow-100';
                else scoreColorClass = 'text-red-600 bg-red-100';

                const qualityScoreFormula = `The Quality Score is a holistic measure based on:
- Empathy & Rapport (30%)
- Problem Identification & Solving (40%)
- Clarity & Confidence (20%)
- Adherence to Procedure (10%)

Scores are penalized for lack of context, repetitive phrases, and failure to de-escalate.`;

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-gray-700">Turn ${this.state.turnCount} Analysis</span>
                        <div class="flex items-center space-x-2">
                             <span class="text-xl">üí°</span>
                             <div class="has-tooltip relative">
                                <span class="text-xl cursor-pointer">‚ÑπÔ∏è</span>
                                <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-800 text-white text-xs rounded p-2 z-10 -translate-x-1/2 left-1/2">
                                    ${qualityScoreFormula.replace(/\n/g, '<br>')}
                                </div>
                             </div>
                             <span class="font-bold text-lg px-2 py-0.5 rounded ${scoreColorClass}">${score}</span>
                        </div>
                    </div>
                    <p class="text-gray-600">${comment}</p>
                `;
                this.qualityPanel.appendChild(div);
                this.qualityPanel.scrollTop = this.qualityPanel.scrollHeight;
            }
            
            buildPrompt(persona) {
                const tone = this.toneSelect.value;
                const lang = this.langSelect.value;
                const interactionLimit = `This is turn number ${this.state.turnCount}. The call should not exceed 10 turns.`;
                let closingInstruction = '';
                if(this.state.turnCount >= 6) {
                    closingInstruction = lang === 'es-ES' ? 
                        'Empieza a buscar una manera de concluir la conversaci√≥n.' :
                        'Start looking for a way to wrap up the conversation.';
                }

                const basePrompt = `${persona} Your tone should be ${tone}. Respond in the language: ${lang}. ${interactionLimit} ${closingInstruction}`;
                
                // Construct a temporary history for the prompt
                const historyForPrompt = [...this.state.chatHistory];
                historyForPrompt.unshift({
                    role: 'user',
                    parts: [{ text: basePrompt }]
                });

                return historyForPrompt;
            }
            
            showLoader(show, text = 'AI is thinking...') {
                this.loaderText.textContent = text;
                this.loader.classList.toggle('hidden', !show);
            }

            async endCall() {
                this.state.callInProgress = false;
                this.speechService.stopRecognition();
                this.messageInput.disabled = true;
                this.micBtn.disabled = true;
                this.statusEl.textContent = this.state.currentLanguage === 'es-ES' ? 'Llamada finalizada.' : 'Call Ended.';
                this.addMessage(this.statusEl.textContent, 'system');
                
                this.showLoader(true, 'Organizer Bot is generating the final report...');
                await this.generateAndShowReport();
                this.showLoader(false);
            }

            async generateAndShowReport() {
                const reportPrompt = this.state.currentLanguage === 'es-ES' ?
                     `Como un Bot Organizador de IA, analiza la siguiente transcripci√≥n de la llamada y las puntuaciones de calidad.
                      Transcripci√≥n: ${JSON.stringify(this.state.fullConversationForReport)}
                      Puntuaciones de calidad por turno: ${this.state.qualityScores.join(', ')}
                      Crea un informe con: 1. Un resumen conciso de la llamada. 2. Una evaluaci√≥n del rendimiento del agente (fortalezas/debilidades). 3. Recomendaciones de autocuraci√≥n para el sistema (por ejemplo, "Sugerir modificar el guion de quejas para manejar mejor X").
                      Devuelve solo un objeto JSON con las claves "summary", "assessment" y "recommendations".` :
                     `As an AI Organizer Bot, analyze the following call transcript and quality scores.
                      Transcript: ${JSON.stringify(this.state.fullConversationForReport)}
                      Quality Scores per turn: ${this.state.qualityScores.join(', ')}
                      Create a report with: 1. A concise summary of the call. 2. An assessment of the agent's performance (fortalezas/debilidades). 3. Self-healing recommendations for the system (e.g., "Suggest modifying complaint script to better handle X.").
                      Return only a JSON object with keys "summary", "assessment", and "recommendations".`;

                try {
                    const responseText = await this.geminiAPI.generateContent(reportPrompt);
                    const cleanedText = responseText.replace(/```json|```/g, '').trim();
                    const reportData = JSON.parse(cleanedText);

                    // Populate Report
                    document.getElementById('report-summary').textContent = reportData.summary;
                    
                    const assessmentHtml = `
                        <p class="mb-2"><strong class="font-semibold">Assessment:</strong> ${reportData.assessment}</p>
                        <p><strong class="font-semibold">Self-Healing Suggestion:</strong> <span class="bg-blue-100 text-blue-800 p-1 rounded">${reportData.recommendations}</span></p>
                    `;
                    document.getElementById('organizer-assessment').innerHTML = assessmentHtml;
                    
                    const finalScore = this.state.qualityScores.length > 0 ? (this.state.qualityScores.reduce((a, b) => a + b, 0) / this.state.qualityScores.length).toFixed(0) : 'N/A';
                    document.getElementById('report-metrics').innerHTML = `
                        <p><strong>Final Average Score:</strong> ${finalScore}</p>
                        <p><strong>Total Turns:</strong> ${this.state.turnCount}</p>
                        <p><strong>Difficulty:</strong> ${this.state.currentScenario.difficulty}</p>
                    `;

                    this.renderQualityChart();

                } catch (e) {
                     console.error("Failed to generate report:", e);
                     document.getElementById('report-summary').textContent = "Error generating report.";
                }

                // Decide if survey should be shown (e.g., 30% chance)
                if (Math.random() < 0.3) {
                    this.surveySection.classList.remove('hidden');
                }
                
                this.reportModal.classList.remove('hidden');
            }

            renderQualityChart() {
                const ctx = document.getElementById('quality-chart').getContext('2d');
                if(window.qualityChartInstance) {
                    window.qualityChartInstance.destroy();
                }
                window.qualityChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: this.state.qualityScores.map((_, i) => `Turn ${i + 1}`),
                        datasets: [{
                            label: 'Quality Score',
                            data: this.state.qualityScores,
                            backgroundColor: this.state.qualityScores.map(score => {
                                if (score >= 85) return 'rgba(16, 185, 129, 0.7)';
                                if (score >= 60) return 'rgba(245, 158, 11, 0.7)';
                                return 'rgba(239, 68, 68, 0.7)';
                            }),
                            borderColor: this.state.qualityScores.map(score => {
                                if (score >= 85) return 'rgba(16, 185, 129, 1)';
                                if (score >= 60) return 'rgba(245, 158, 11, 1)';
                                return 'rgba(239, 68, 68, 1)';
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: { legend: { display: false }, title: { display: true, text: 'Quality Score per Interaction Turn'} }
                    }
                });
            }
            
            exportReport() {
                 const summary = document.getElementById('report-summary').textContent;
                 const assessment = document.getElementById('organizer-assessment').innerText;
                 const metrics = document.getElementById('report-metrics').innerText;
                 const fullTranscript = this.state.fullConversationForReport.map(msg => `${msg.speaker}: ${msg.text}`).join('\n');

                 const reportText = `
CALL SIMULATION REPORT
======================
Date: ${new Date().toLocaleString()}
Scenario: ${this.state.currentScenario.scenario}
Customer: ${this.state.currentScenario.customerName}
----------------------

METRICS
-------
${metrics}

ORGANIZER ASSESSMENT
--------------------
${assessment}

CALL SUMMARY
------------
${summary}

FULL TRANSCRIPT
---------------
${fullTranscript}
                 `;

                 const blob = new Blob([reportText.trim()], { type: 'text/plain' });
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(blob);
                 link.download = `CallReport_${new Date().toISOString()}.txt`;
                 link.click();
                 URL.revokeObjectURL(link.href);
            }
        }

        // --- SERVICES ---
        class SpeechService {
            constructor(getIsRecognizing, setIsRecognizing, onResult, onError) {
                this.getIsRecognizing = getIsRecognizing;
                this.setIsRecognizing = setIsRecognizing;
                this.onResult = onResult;
                this.onError = onError;

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error("Speech Recognition not supported.");
                    return;
                }
                this.recognition = new SpeechRecognition();
                this.recognition.interimResults = true;
                this.recognition.continuous = true;

                this.recognition.onstart = () => this.setIsRecognizing(true);
                this.recognition.onend = () => this.setIsRecognizing(false);
                this.recognition.onerror = (event) => this.onError(event.error);
                this.recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        this.onResult(finalTranscript);
                    }
                };
            }

            toggleRecognition(lang) {
                if (this.getIsRecognizing()) {
                    this.recognition.stop();
                } else {
                    this.recognition.lang = lang;
                    this.recognition.start();
                }
            }

            stopRecognition() {
                if(this.getIsRecognizing()) {
                    this.recognition.stop();
                }
            }
        }

        class GeminiAPIService {
            constructor() {
                this.API_KEY = "AIzaSyDEdZtmIWDlMIEgL3c73Gxu0aXoAkt3MWE"; // Updated API Key
                this.API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.API_KEY}`;
            }

            async generateContent(promptOrHistory) {
                const payload = {
                    contents: Array.isArray(promptOrHistory) ? promptOrHistory : [{ role: 'user', parts: [{ text: promptOrHistory }] }]
                };
                
                try {
                    const response = await fetch(this.API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    const data = await response.json();
                    
                    if (data.candidates && data.candidates.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    }
                    return "(No AI response received)";

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    return `(Error: Could not get AI response - ${error.message})`;
                }
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            new AppController();
        });
    </script>
</body>
</html>
